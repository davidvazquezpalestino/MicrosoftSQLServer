UPDATE axiliar SET IdTipoDDominio = 700
FROM dbo.tCNTauxiliares axiliar 
WHERE IdAuxiliar > 0
GO	

UPDATE tCNTauxiliares SET  IdTipoDDominio = 232 WHERE IdAuxiliar = -120 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -119 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -118 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -117 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -116 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -115 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -114 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -113 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -112 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -111 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -110 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -109 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -108 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -107 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -106 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -105 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -104 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -103 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -102 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -101 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -100 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -74 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -73 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -72 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 137 WHERE IdAuxiliar = -71 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -70 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -69 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -68 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 232 WHERE IdAuxiliar = -67 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 232 WHERE IdAuxiliar = -66 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -65 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -64 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -63 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -62 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -61 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -60 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -59 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -57 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -56 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -55 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -54 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -53 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 232 WHERE IdAuxiliar = -50 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -48 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -47 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 137 WHERE IdAuxiliar = -46 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -45 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -44 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -43 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -42 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -41 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -40 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -39 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -38 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -37 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -36 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -35 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -34 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -33 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -32 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -31 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 137 WHERE IdAuxiliar = -30 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -29 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -28 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -27 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -26 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -25 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 137 WHERE IdAuxiliar = -24 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 136 WHERE IdAuxiliar = -23 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 136 WHERE IdAuxiliar = -22 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 136 WHERE IdAuxiliar = -21 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -20 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -19 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -18 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -17 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 232 WHERE IdAuxiliar = -16 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 232 WHERE IdAuxiliar = -15 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 232 WHERE IdAuxiliar = -14 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 232 WHERE IdAuxiliar = -13 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -12 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -11 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -10 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -9 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -8 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -7 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -6 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -5 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -4 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -3 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -2 
UPDATE tCNTauxiliares SET  IdTipoDDominio = 700 WHERE IdAuxiliar = -1 
GO


/* ==========================================
  Por:  David Vázquez Palestino
Fecha:  02/12/2019
=============================================*/
IF EXISTS (SELECT OBJECT_ID FROM SYS.PROCEDURES WHERE OBJECT_ID = OBJECT_ID('pCRUDsaldos'))
	DROP PROCEDURE pCRUDsaldos
GO

CREATE PROC [dbo].[pCRUDsaldos]
		@TipoOperacion varchar(5),
		@IdSaldo as int = 0 output,
		@IdUltimaTransaccion as int = 0,
		@IdUltimaTransaccionFinanciera as int = 0,
		@Descripcion as varchar(80) = '',
		@IdOperacion as int = 0,
		@IdPersona as int = 0,
		@IdCliente as int = 0,
		@IdSocio as int = 0,
		@IdEmisorProveedor as int = 0,
		@IdCuentaABCD as int = 0,
		@Parcialidad as int = 0,
		@IdAuxiliar as int = 0,
		@IdProyecto as int = 0,
		@IdCuenta as int = 0,
		@IdDivision as int = 0,
		@IdEntidad1 as int = 0,
		@IdEntidad2 as int = 0,
		@IdEntidad3 as int = 0,
		@IdBienServicio as int = 0,
		@IdOperacionD as int = 0,
		@IdAgrupadorSaldo as int = 0,
		@Vencimiento as date = '19000101',
		@Pagado as date = '19000101',
		@PagadoInteresOrdinario as date = '19000101',
		@IdDivisa as int = 0,
		@FactorDivisa as numeric(23,8) = 0,
		@Monto as numeric(23,8) = 0,
		@MontoLocal as numeric(23,8) = 0,
		@Naturaleza as smallint = 0,
		@MontoBloqueado as numeric(23,8) = 0,
		@MontoBloqueadoLocal as numeric(23,8) = 0,
		@SubTotalGenerado as numeric(23,8) = 0,
		@SubTotalGeneradoLocal as numeric(23,8) = 0,
		@ImpuestosGenerados as numeric(23,8) = 0,
		@ImpuestosGeneradosLocal as numeric(23,8) = 0,
		@RetencionesGeneradas as numeric(23,8) = 0,
		@RetencionesGeneradasLocal as numeric(23,8) = 0,
		@SubTotalPagado as numeric(23,8) = 0,
		@SubTotalPagadoLocal as numeric(23,8) = 0,
		@ImpuestosPagados as numeric(23,8) = 0,
		@ImpuestosPagadosLocal as numeric(23,8) = 0,
		@RetencionesPagadas as numeric(23,8) = 0,
		@RetencionesPagadasLocal as numeric(23,8) = 0,
		@CapitalGenerado as numeric(23,8) = 0,
		@CapitalGeneradoLocal as numeric(23,8) = 0,
		@InteresOrdinarioDevengado as numeric(23,8) = 0,
		@InteresOrdinarioDevengadoLocal as numeric(23,8) = 0,
		@InteresMoratorioDevengado as numeric(23,8) = 0,
		@InteresMoratorioDevengadoLocal as numeric(23,8) = 0,
		@CargosGenerados as numeric(23,8) = 0,
		@CargosGeneradosLocal as numeric(23,8) = 0,
		@CapitalPagado as numeric(23,8) = 0,
		@CapitalPagadoLocal as numeric(23,8) = 0,
		@InteresOrdinarioPagado as numeric(23,8) = 0,
		@InteresOrdinarioPagadoLocal as numeric(23,8) = 0,
		@InteresMoratorioPagado as numeric(23,8) = 0,
		@InteresMoratorioPagadoLocal as numeric(23,8) = 0,
		@CargosPagados as numeric(23,8) = 0,
		@CargosPagadosLocal as numeric(23,8) = 0,
		@CapitalCondonado as numeric(23,8) = 0,
		@CapitalCondonadoLocal as numeric(23,8) = 0,
		@InteresOrdinarioCondonado as numeric(23,8) = 0,
		@InteresOrdinarioCondonadoLocal as numeric(23,8) = 0,
		@InteresMoratorioCondonado as numeric(23,8) = 0,
		@InteresMoratorioCondonadoLocal as numeric(23,8) = 0,
		@CargosCondonados as numeric(23,8) = 0,
		@CargosCondonadosLocal as numeric(23,8) = 0,
		@InteresCapitalizado as numeric(23,8) = 0,
		@InteresCapitalizadoLocal as numeric(23,8) = 0,
		@IVADevengado as numeric(23,8) = 0,
		@IVADevengadoLocal as numeric(23,8) = 0,
		@BaseIVA as numeric(23,8) = 0,
		@BaseIVALocal as numeric(23,8) = 0,
		@IVAPagado as numeric(23,8) = 0,
		@IVAPagadoLocal as numeric(23,8) = 0,
		@IVACondonado as numeric(23,8) = 0,
		@IVACondonadoLocal as numeric(23,8) = 0,
		@RetencionISR as numeric(23,8) = 0,
		@RetencionISRLocal as numeric(23,8) = 0,
		@RetencionIDE as numeric(23,8) = 0,
		@RetencionIDELocal as numeric(23,8) = 0,
		@InteresOrdinarioCuentasOrden as numeric(23,8) = 0,
		@InteresOrdinarioCuentasOrdenLocal as numeric(23,8) = 0,
		@InteresMoratorioCuentasOrden as numeric(23,8) = 0,
		@InteresMoratorioCuentasOrdenLocal as numeric(23,8) = 0,
		@IdTasaImpuesto as int = 0,
		@IdPeriodo as int = 0,
		@IdEstructuraContableDsaldo as int = 0,
		@IdEstructuraContable as int = 0,
		@Factor as smallint=0,
		@IVAInteresOrdinarioDevengado AS NUMERIC(23,8)=0, 
		@IVAInteresOrdinarioPagado AS NUMERIC(23,8)=0, 
		@IVAInteresOrdinarioCondonado AS NUMERIC(23,8)=0, 
		@IVAInteresMoratorioDevengado AS NUMERIC(23,8)=0, 
		@IVAInteresMoratorioPagado AS NUMERIC(23,8)=0, 
		@IVAInteresMoratorioCondonado AS NUMERIC(23,8)=0, 
		@IVACargosDevengado AS NUMERIC(23,8)=0, 
		@IVACargosPagado AS NUMERIC(23,8)=0, 
		@IVACargosCondonado AS NUMERIC(23,8)=0,
		@IdSucursal as int = 0,
		@IdEstatus as int = 0,
		@IdUsuarioAlta AS INT = 0,
		@IdUsuarioUltimoCambio AS INT = 0,		
		@IdSesion AS INT = 0   ,
		@Fecha AS DATE='19000101',
		@Codigo AS VARCHAR(30)='',
		@RequiereAutorizacionPago AS BIT= 0,
		@MontoAutorizado AS NUMERIC (18,2)= 0
        

	AS 
		SET NOCOUNT ON 
		SET XACT_ABORT ON
		
		IF (@TipoOperacion IN ('C','U'))
		BEGIN
	
			IF @IdCuenta<>0 
			BEGIN
				SELECT @Descripcion = pf.Descripcion, @Codigo = cta.Codigo 
				FROM dbo.tAYCcuentas cta (NOLOCK)
				INNER JOIN dbo.tAYCproductosFinancieros pf WITH(NOLOCK)on pf.IdProductoFinanciero=cta.IdProductoFinanciero
				WHERE cta.IdCuenta = @IdCuenta;
			END;

			ELSE 			
				IF @IdOperacion > 0
				BEGIN
					DECLARE @TipoSaldo AS VARCHAR(64);
					SELECT @TipoSaldo = Codigo
					FROM dbo.tCNTauxiliares WITH( NOLOCK )
					WHERE IdAuxiliar = @IdAuxiliar;

					SELECT @Codigo = CONCAT(ISNULL(@TipoSaldo, ''), '-', OperacionPadre.Serie, OperacionPadre.Folio),
						@Descripcion = CONCAT(ISNULL(@TipoSaldo, ''), '-', OperacionPadre.Serie, OperacionPadre.Folio)
					FROM dbo.tGRLoperaciones OperacionPadre
					INNER JOIN dbo.tGRLoperaciones Operacion ON Operacion.IdOperacionPadre = OperacionPadre.IdOperacion
					WHERE Operacion.IdOperacion = @IdOperacion;
				END;			             					
		END;
					
		IF (@TipoOperacion='C')
		BEGIN
			
			
			DECLARE @IdTipoDDominioCatalogo as INT
			
			SELECT @IdTipoDDominioCatalogo = tc.IdTipoDdominioOrigen,@RequiereAutorizacionPago = tc.RequiereAutorizacionPago
			FROM tCNTauxiliares tc (NOLOCK)
			WHERE tc.IdAuxiliar = @IdAuxiliar;

			IF ISNULL(@Fecha ,'19000101') IN( '19000101','00010101')
			BEGIN
				SELECT @Fecha = sesion.FechaTrabajo
				FROM dbo.tCTLsesiones sesion
				WHERE sesion.IdSesion = @IdSesion
            END

			IF @IdOperacion!=0
			BEGIN
				SELECT @Fecha = operacion.Fecha, @Vencimiento = DATEADD(DAY, ISNULL(cPago.Dias,0),@Fecha)
				FROM dbo.tGRLoperaciones operacion
				LEFT JOIN dbo.tCATcondicionesPago cPago ON cPago.IdCondicionPago = operacion.IdCondicionPago
				WHERE operacion.IdOperacion = @IdOperacion
            END

			IF ISNULL(@Vencimiento ,'19000101') IN( '19000101','00010101')
			BEGIN
				SET @Vencimiento = @Fecha
            END
			
				--2.3.25 
				DECLARE @IdTipoDDominio INT = 0;
				SELECT @IdTipoDDominio = IdTipoDDominio
				FROM dbo.tCNTauxiliares Auxiliar
				WHERE Auxiliar.IdAuxiliar = @IdAuxiliar;

				/*=========================
						CLIENTE
				=========================*/
				IF @IdTipoDDominio = 136
				BEGIN
					SELECT @IdEstructuraContable = Estructura.IdEstructuraContableE
					FROM dbo.tSCSclientes Cliente WITH(NOLOCK)
					INNER JOIN dbo.tGRLestructurasCatalogos Estructura WITH(NOLOCK) ON Estructura.IdEstructuraCatalogo = Cliente.IdEstructuraCatalogo
					WHERE IdCliente = @IdCliente
				END
				/*=========================
					EMISOR / PROVEEDOR
				=========================*/
				IF @IdTipoDDominio = 137
				BEGIN
					SELECT @IdEstructuraContable = Estructura.IdEstructuraContableE
					FROM dbo.tSCSemisoresProveedores Proveedor WITH(NOLOCK)
					INNER JOIN dbo.tGRLestructurasCatalogos Estructura WITH(NOLOCK) ON Estructura.IdEstructuraCatalogo = Proveedor.IdEstructuraCatalogo
					WHERE Proveedor.IdEmisorProveedor = @IdEmisorProveedor
				END
				/*=========================
						CUENTA
				=========================*/
				IF @IdTipoDDominio = 232
				BEGIN
					SELECT @IdEstructuraContable = Estructura.IdEstructuraContableE
					FROM dbo.tAYCcuentas Cuenta WITH( NOLOCK )
					INNER JOIN dbo.tAYCproductosFinancieros Producto WITH( NOLOCK )ON Producto.IdProductoFinanciero     = Cuenta.IdProductoFinanciero
					INNER JOIN dbo.tGRLestructurasCatalogos Estructura WITH( NOLOCK )ON Estructura.IdEstructuraCatalogo = Producto.IdEstructuraCatalogo
					WHERE Cuenta.IdCuenta = @IdCuenta;
				END
				/*=========================
					DEUDORES / ACREEDORES
				=========================*/
				IF @IdTipoDDominio = 700
				BEGIN
					SELECT @IdEstructuraContable = Estructura.IdEstructuraContableE
					FROM dbo.tGRLcuentasABCD Cuenta WITH( NOLOCK )
					INNER JOIN dbo.tGRLestructurasCatalogos Estructura WITH( NOLOCK )ON Estructura.IdEstructuraCatalogo = Cuenta.IdEstructuraCatalogo
					WHERE Cuenta.IdCuentaABCD = @IdCuentaABCD;
				END

			INSERT INTO [dbo].[tSDOsaldos] (IdTipoDDominioCatalogo, IdUltimaTransaccion, IdUltimaTransaccionFinanciera, Descripcion, IdOperacion, IdPersona, IdCliente, IdSocio, IdEmisorProveedor, IdCuentaABCD, Parcialidad, IdAuxiliar, IdProyecto, IdCuenta, IdDivision, IdEntidad1, IdEntidad2, IdEntidad3, IdBienServicio, IdOperacionD, IdAgrupadorSaldo, Vencimiento, Pagado, PagadoInteresOrdinario, IdDivisa, FactorDivisa, Monto, MontoLocal, Naturaleza, MontoBloqueado, MontoBloqueadoLocal, SubTotalGenerado, SubTotalGeneradoLocal, ImpuestosGenerados, ImpuestosGeneradosLocal, RetencionesGeneradas, RetencionesGeneradasLocal, SubTotalPagado, SubTotalPagadoLocal, ImpuestosPagados, ImpuestosPagadosLocal, RetencionesPagadas, RetencionesPagadasLocal, CapitalGenerado, CapitalGeneradoLocal, InteresOrdinarioDevengado, InteresOrdinarioDevengadoLocal, InteresMoratorioDevengado, InteresMoratorioDevengadoLocal, CargosGenerados, CargosGeneradosLocal, CapitalPagado, CapitalPagadoLocal, InteresOrdinarioPagado, InteresOrdinarioPagadoLocal, InteresMoratorioPagado, InteresMoratorioPagadoLocal, CargosPagados, CargosPagadosLocal, CapitalCondonado, CapitalCondonadoLocal, InteresOrdinarioCondonado, InteresOrdinarioCondonadoLocal, InteresMoratorioCondonado, InteresMoratorioCondonadoLocal, CargosCondonados, CargosCondonadosLocal, InteresCapitalizado, InteresCapitalizadoLocal, IVADevengado, IVADevengadoLocal, BaseIVA, BaseIVALocal, IVAPagado, IVAPagadoLocal, IVACondonado, IVACondonadoLocal, RetencionISR, RetencionISRLocal, RetencionIDE, RetencionIDELocal, InteresOrdinarioCuentasOrden, InteresOrdinarioCuentasOrdenLocal, InteresMoratorioCuentasOrden, InteresMoratorioCuentasOrdenLocal, IdTasaImpuesto, IdPeriodo, IdEstructuraContableDsaldo, IdEstructuraContable,Factor,IVAInteresOrdinarioDevengado,
						IVAInteresOrdinarioPagado, IVAInteresOrdinarioCondonado,
						IVAInteresMoratorioDevengado, IVAInteresMoratorioPagado,
						IVAInteresMoratorioCondonado, IVACargosDevengado,
						IVACargosPagado, IVACargosCondonado, IdSucursal, IdEstatus,IdUsuarioAlta,
						IdUsuarioUltimoCambio, Alta, UltimaModificacion, IdSesion,Fecha,Codigo,RequiereAutorizacionPago,MontoAutorizado)
			VALUES (@IdTipoDDominioCatalogo, @IdUltimaTransaccion, @IdUltimaTransaccionFinanciera, @Descripcion, @IdOperacion, @IdPersona, @IdCliente, @IdSocio, @IdEmisorProveedor, @IdCuentaABCD, @Parcialidad, @IdAuxiliar, @IdProyecto, @IdCuenta, @IdDivision, @IdEntidad1, @IdEntidad2, @IdEntidad3, @IdBienServicio, @IdOperacionD, @IdAgrupadorSaldo, @Vencimiento, @Pagado, @PagadoInteresOrdinario, @IdDivisa, @FactorDivisa, @Monto, @MontoLocal, @Naturaleza, @MontoBloqueado, @MontoBloqueadoLocal, @SubTotalGenerado, @SubTotalGeneradoLocal, @ImpuestosGenerados, @ImpuestosGeneradosLocal, @RetencionesGeneradas, @RetencionesGeneradasLocal, @SubTotalPagado, @SubTotalPagadoLocal, @ImpuestosPagados, @ImpuestosPagadosLocal, @RetencionesPagadas, @RetencionesPagadasLocal, @CapitalGenerado, @CapitalGeneradoLocal, @InteresOrdinarioDevengado, @InteresOrdinarioDevengadoLocal, @InteresMoratorioDevengado, @InteresMoratorioDevengadoLocal, @CargosGenerados, @CargosGeneradosLocal, @CapitalPagado, @CapitalPagadoLocal, @InteresOrdinarioPagado, @InteresOrdinarioPagadoLocal, @InteresMoratorioPagado, @InteresMoratorioPagadoLocal, @CargosPagados, @CargosPagadosLocal, @CapitalCondonado, @CapitalCondonadoLocal, @InteresOrdinarioCondonado, @InteresOrdinarioCondonadoLocal, @InteresMoratorioCondonado, @InteresMoratorioCondonadoLocal, @CargosCondonados, @CargosCondonadosLocal, @InteresCapitalizado, @InteresCapitalizadoLocal, @IVADevengado, @IVADevengadoLocal, @BaseIVA, @BaseIVALocal, @IVAPagado, @IVAPagadoLocal, @IVACondonado, @IVACondonadoLocal, @RetencionISR, @RetencionISRLocal, @RetencionIDE, @RetencionIDELocal, @InteresOrdinarioCuentasOrden, @InteresOrdinarioCuentasOrdenLocal, @InteresMoratorioCuentasOrden, @InteresMoratorioCuentasOrdenLocal, @IdTasaImpuesto, @IdPeriodo, @IdEstructuraContableDsaldo, @IdEstructuraContable,@factor,@IVAInteresOrdinarioDevengado,@IVAInteresOrdinarioPagado,@IVAInteresOrdinarioCondonado,@IVAInteresMoratorioDevengado,@IVAInteresMoratorioPagado,@IVAInteresMoratorioCondonado,	@IVACargosDevengado,@IVACargosPagado,@IVACargosCondonado, @IdSucursal, @IdEstatus,@IdUsuarioAlta,
			       @IdUsuarioUltimoCambio, GETDATE(), GETDATE(), @IdSesion,@Fecha,@Codigo,@RequiereAutorizacionPago,@MontoAutorizado)
			SET @IdSaldo = SCOPE_IDENTITY()
		END
	
		IF (@TipoOperacion='R')
		BEGIN
			EXECUTE dbo.pCRUDsaldosR @IdSaldo = @IdSaldo
		END

		IF (@TipoOperacion='U')
		BEGIN
			UPDATE [dbo].[tSDOsaldos] 
			SET IdUltimaTransaccion=@IdUltimaTransaccion, IdUltimaTransaccionFinanciera=@IdUltimaTransaccionFinanciera, Descripcion=@Descripcion, IdOperacion=@IdOperacion, IdPersona=@IdPersona, IdCliente=@IdCliente, IdSocio=@IdSocio, IdEmisorProveedor = @IdEmisorProveedor, IdCuentaABCD=@IdCuentaABCD, Parcialidad=@Parcialidad, IdAuxiliar=@IdAuxiliar, IdProyecto=@IdProyecto, IdCuenta=@IdCuenta, IdDivision=@IdDivision, IdEntidad1=@IdEntidad1, IdEntidad2=@IdEntidad2, IdEntidad3=@IdEntidad3, IdBienServicio=@IdBienServicio, IdOperacionD=@IdOperacionD, IdAgrupadorSaldo=@IdAgrupadorSaldo, Vencimiento=@Vencimiento, Pagado=@Pagado, PagadoInteresOrdinario=@PagadoInteresOrdinario, IdDivisa=@IdDivisa, FactorDivisa=@FactorDivisa, Monto=@Monto, MontoLocal=@MontoLocal, Naturaleza=@Naturaleza, MontoBloqueado=@MontoBloqueado, MontoBloqueadoLocal=@MontoBloqueadoLocal, SubTotalGenerado=@SubTotalGenerado, SubTotalGeneradoLocal=@SubTotalGeneradoLocal, ImpuestosGenerados=@ImpuestosGenerados, ImpuestosGeneradosLocal=@ImpuestosGeneradosLocal, RetencionesGeneradas=@RetencionesGeneradas, RetencionesGeneradasLocal=@RetencionesGeneradasLocal, SubTotalPagado=@SubTotalPagado, SubTotalPagadoLocal=@SubTotalPagadoLocal, ImpuestosPagados=@ImpuestosPagados, ImpuestosPagadosLocal=@ImpuestosPagadosLocal, RetencionesPagadas=@RetencionesPagadas, RetencionesPagadasLocal=@RetencionesPagadasLocal, CapitalGenerado=@CapitalGenerado, CapitalGeneradoLocal=@CapitalGeneradoLocal, InteresOrdinarioDevengado=@InteresOrdinarioDevengado, InteresOrdinarioDevengadoLocal=@InteresOrdinarioDevengadoLocal, InteresMoratorioDevengado=@InteresMoratorioDevengado, InteresMoratorioDevengadoLocal=@InteresMoratorioDevengadoLocal, CargosGenerados=@CargosGenerados, CargosGeneradosLocal=@CargosGeneradosLocal, CapitalPagado=@CapitalPagado, CapitalPagadoLocal=@CapitalPagadoLocal, InteresOrdinarioPagado=@InteresOrdinarioPagado, InteresOrdinarioPagadoLocal=@InteresOrdinarioPagadoLocal, InteresMoratorioPagado=@InteresMoratorioPagado, InteresMoratorioPagadoLocal=@InteresMoratorioPagadoLocal, CargosPagados=@CargosPagados, CargosPagadosLocal=@CargosPagadosLocal, CapitalCondonado=@CapitalCondonado, CapitalCondonadoLocal=@CapitalCondonadoLocal, InteresOrdinarioCondonado=@InteresOrdinarioCondonado, InteresOrdinarioCondonadoLocal=@InteresOrdinarioCondonadoLocal, InteresMoratorioCondonado=@InteresMoratorioCondonado, InteresMoratorioCondonadoLocal=@InteresMoratorioCondonadoLocal, CargosCondonados=@CargosCondonados, CargosCondonadosLocal=@CargosCondonadosLocal, InteresCapitalizado=@InteresCapitalizado, InteresCapitalizadoLocal=@InteresCapitalizadoLocal, IVADevengado=@IVADevengado, IVADevengadoLocal=@IVADevengadoLocal, BaseIVA=@BaseIVA, BaseIVALocal=@BaseIVALocal, IVAPagado=@IVAPagado, IVAPagadoLocal=@IVAPagadoLocal, IVACondonado=@IVACondonado, IVACondonadoLocal=@IVACondonadoLocal, RetencionISR=@RetencionISR, RetencionISRLocal=@RetencionISRLocal, RetencionIDE=@RetencionIDE, RetencionIDELocal=@RetencionIDELocal, InteresOrdinarioCuentasOrden=@InteresOrdinarioCuentasOrden, InteresOrdinarioCuentasOrdenLocal=@InteresOrdinarioCuentasOrdenLocal, InteresMoratorioCuentasOrden=@InteresMoratorioCuentasOrden, InteresMoratorioCuentasOrdenLocal=@InteresMoratorioCuentasOrdenLocal, IdTasaImpuesto=@IdTasaImpuesto, IdPeriodo=@IdPeriodo, IdEstructuraContableDsaldo=@IdEstructuraContableDsaldo, IdEstructuraContable=@IdEstructuraContable,Factor=@Factor, IdSucursal=@IdSucursal ,IdEstatus=@IdEstatus,IdUsuarioUltimoCambio = @IdUsuarioUltimoCambio,
			 UltimaModificacion = GETDATE(),Codigo = @Codigo,RequiereAutorizacionPago = @RequiereAutorizacionPago,MontoAutorizado = @MontoAutorizado
			WHERE (IdSaldo=@IdSaldo)
		END

		IF (@TipoOperacion='U2')
		BEGIN
			UPDATE [dbo].[tSDOsaldos] 
				SET CapitalGenerado = @CapitalGenerado, 
				InteresOrdinarioDevengado=@InteresOrdinarioDevengado, 						
				IVAInteresOrdinarioDevengado = @IVAInteresOrdinarioDevengado,	
				InteresMoratorioDevengado = @InteresMoratorioDevengado,		
				IVAInteresMoratorioDevengado = @IVAInteresMoratorioDevengado,			
				UltimaModificacion = GETDATE()
			WHERE (IdSaldo=@IdSaldo)
		END

		IF (@TipoOperacion='D')
		BEGIN
			DELETE FROM tSDOsaldos
			WHERE IdSaldo=@IdSaldo
		END
GO

---------FIX A conceptos IdImpuestoCompra---------------

UPDATE x SET x.IdImpuestoCompra = IdImpuesto
FROM dbo.tGRLbienesServicios x
WHERE IdTipoD = 1575 AND IdImpuestoCompra = 0


UPDATE x SET x.IdImpuesto = 0
FROM dbo.tGRLbienesServicios x
WHERE IdTipoD = 1575 AND IdImpuestoCompra != 0

----------

IF NOT EXISTS(SELECT IdDominioRubro FROM tCTLdominiosRubros WHERE IdTipoDDominio =  2248 AND IdTipoDRubro = 169) 
BEGIN
	INSERT INTO tCTLdominiosRubros(IdTipoDDominio, IdTipoDRubro, IdTipoDCuentaContable, Orden, IdEstatus, IdTipoDCuentaContablePadre, IdTipoDCuentaContableGrupo, IdAuxiliar, Grupo) 
	VALUES (2248, 169, 0, 0, 1, 0, 0, 0, 'Activos') 
END
IF NOT EXISTS(SELECT IdDominioRubro FROM tCTLdominiosRubros WHERE IdTipoDDominio =  2248 AND IdTipoDRubro = 170) 
BEGIN
	INSERT INTO tCTLdominiosRubros(IdTipoDDominio, IdTipoDRubro, IdTipoDCuentaContable, Orden, IdEstatus, IdTipoDCuentaContablePadre, IdTipoDCuentaContableGrupo, IdAuxiliar, Grupo) 
	VALUES (2248, 170, 0, 1, 1, 0, 0, 0, 'Activos') 
END
IF NOT EXISTS(SELECT IdDominioRubro FROM tCTLdominiosRubros WHERE IdTipoDDominio =  2248 AND IdTipoDRubro = 156) 
BEGIN
	INSERT INTO tCTLdominiosRubros(IdTipoDDominio, IdTipoDRubro, IdTipoDCuentaContable, Orden, IdEstatus, IdTipoDCuentaContablePadre, IdTipoDCuentaContableGrupo, IdAuxiliar, Grupo) 
	VALUES (2248, 156, 0, 2, 1, 0, 0, 0, 'Activos') 
END
IF NOT EXISTS(SELECT IdDominioRubro FROM tCTLdominiosRubros WHERE IdTipoDDominio =  2248 AND IdTipoDRubro = 2254) 
BEGIN
	INSERT INTO tCTLdominiosRubros(IdTipoDDominio, IdTipoDRubro, IdTipoDCuentaContable, Orden, IdEstatus, IdTipoDCuentaContablePadre, IdTipoDCuentaContableGrupo, IdAuxiliar, Grupo) 
	VALUES (2248, 2254, 0, 3, 1, 0, 0, 0, 'Activos') 
END
-----------------------------------
UPDATE x SET x.Descripcion = 'ARTÍCULO INVENTARIABLE', x.DescripcionLarga = 'ARTÍCULO INVENTARIABLE'
FROM dbo.tCTLtiposD x
WHERE IdTipoD = 139

-------------------------------
--cambia el órden de los grupos en los rubros de Artículos
UPDATE x SET x.Grupo = CASE WHEN Grupo = '1. Ventas' THEN '2. Ventas'
            WHEN Grupo = '2. Compras' THEN '3. Compras'
            WHEN Grupo = '3. Cuentas x Pagar' THEN '4. Cuentas x Pagar'
            WHEN Grupo = '4. Almacén' THEN '1. Almacén'
			WHEN Grupo = '2. Cuentas x Cobrar' THEN '5. Cuentas x Cobrar'
       END 
FROM dbo.tCTLdominiosRubros x
WHERE IdTipoDDominio = 139;
-------------------------------
UPDATE x SET x.Descripcion = UPPER(Descripcion), x.DescripcionLarga = UPPER(DescripcionLarga)
FROM dbo.tCTLtiposD x
WHERE IdTipoE = 334
---------------------------------

UPDATE x SET x.IdEstatus = IIF(IdTipoD IN ( 2243, 2247, 2246 ), 2, 1)
FROM dbo.tCTLtiposD x
WHERE IdTipoE = 334 AND x.IdTipoD IN ( 2243, 2247, 2246, 2255 );
------------------------------
IF NOT EXISTS( SELECT IdTipoD FROM tCTLtiposd WHERE IdTipoD = 2637)
	INSERT INTO dbo.tCTLtiposD (IdTipoD, Codigo ,Descripcion, DescripcionLarga, IdTipoE, IdTipoDPadre, RangoInicio, RangoFin, PermiteHistorial, PermiteCambios, TipoDivisaDivision,Valor, UsaEstructuraCatalogo, IdEstatus, IdTipoDestatus, IdEstatusPrincipal)    
	VALUES ( 2637,'ARTNI','ARTÍCULO NO INVENTARIABLE','ARTÍCULO NO INVENTARIABLE',13,244,0,0,0,0,0,0,0,1 ,14,1)
IF NOT EXISTS( SELECT IdTipoD FROM tCTLtiposd WHERE IdTipoD = 2638)
	INSERT INTO dbo.tCTLtiposD (IdTipoD, Codigo ,Descripcion, DescripcionLarga, IdTipoE, IdTipoDPadre, RangoInicio, RangoFin, PermiteHistorial, PermiteCambios, TipoDivisaDivision,Valor, UsaEstructuraCatalogo, IdEstatus, IdTipoDestatus, IdEstatusPrincipal)    
	VALUES ( 2638,'ARTPC','ARTÍCULO PENDIENTE DE CLASIFICAR','ARTÍCULO PENDIENTE DE CLASIFICAR',13,244,0,0,0,0,0,0,0,1 ,14,1)


IF NOT EXISTS(SELECT IdDominioRubro FROM tCTLdominiosRubros WHERE IdTipoDDominio = 2638 AND IdTipoDRubro = 2254) 
BEGIN
	INSERT INTO tCTLdominiosRubros(IdTipoDDominio, IdTipoDRubro, IdTipoDCuentaContable, Orden, IdEstatus, IdTipoDCuentaContablePadre, IdTipoDCuentaContableGrupo, IdAuxiliar, Grupo) 
	VALUES (2638, 2254, 0, 1, 1, 0, 0, 0, '') 
END

-------------------------------------------
DELETE Estructura
FROM dbo.tCNTestructurasContablesD Estructura
INNER JOIN dbo.tCTLdominiosRubros Dominio ON Dominio.IdDominioRubro = Estructura.IdDominioRubro
INNER JOIN dbo.tCTLtiposD Tipo ON Tipo.IdTipoD = Dominio.IdTipoDRubro
WHERE Dominio.IdTipoDDominio = 139 AND Dominio.IdTipoDRubro IN (167, 172, 154, 155, 274, 153)

DELETE DominioRubro
FROM dbo.tCTLdominiosRubros DominioRubro
INNER JOIN dbo.tCTLtiposD Tipo ON Tipo.IdTipoD = DominioRubro.IdTipoDRubro
WHERE IdTipoDDominio = 139 AND DominioRubro.IdTipoDRubro IN (167, 172, 154, 155, 274, 153)

SELECT *
FROM dbo.tCTLdominiosRubros DominioRubro
INNER JOIN dbo.tCTLtiposD Tipo ON Tipo.IdTipoD = DominioRubro.IdTipoDRubro
WHERE IdTipoDDominio = 139 
ORDER BY DominioRubro.Grupo


IF NOT EXISTS(SELECT IdEstatusActual FROM tCTLestatusActual WHERE IdEstatusActual =  -2518) BEGINSET IDENTITY_INSERT tCTLestatusActual ON;	
	INSERT INTO tCTLestatusActual(IdEstatusActual, IdEstatus, IdUsuarioAlta, Alta, IdUsuarioCambio, UltimoCambio, IdTipoDDominio, IdObservacionE, IdObservacionEDominio, IdSesion, IdControl) 
	VALUES (-2518, 1, -1, '20191202', 0, '20191202', 221, 0, 0, 0, -22) SET IDENTITY_INSERT tCTLestatusActual OFF;END

IF NOT EXISTS(SELECT IdEstructuraContableE FROM tCNTestructurasContablesE WHERE IdEstructuraContableE =  -22) BEGINSET IDENTITY_INSERT tCNTestructurasContablesE ON;	
	INSERT INTO tCNTestructurasContablesE(IdEstructuraContableE, Codigo, Descripcion, IdTipoDDominioCatalogo, IdTipoDProductoFinanciero, IdEstatusActual) 
	VALUES (-22, 'ART.NO.INV', 'ESTRUCTURA CONT. DE ARTÍCULOS NO INVENTARIABLES', 2637, 0, -2518) SET IDENTITY_INSERT tCNTestructurasContablesE OFF;END


IF NOT EXISTS(SELECT IdDominioRubro FROM tCTLdominiosRubros WHERE IdTipoDDominio =  2637 AND IdTipoDRubro = 156) 
BEGIN
	INSERT INTO tCTLdominiosRubros(IdTipoDDominio, IdTipoDRubro, IdTipoDCuentaContable, Orden, IdEstatus, IdTipoDCuentaContablePadre, IdTipoDCuentaContableGrupo, IdAuxiliar, Grupo) 
	VALUES (2637, 156, 0, 10, 1, 0, 0, 0, '3. Compras') END
IF NOT EXISTS(SELECT IdDominioRubro FROM tCTLdominiosRubros WHERE IdTipoDDominio =  2637 AND IdTipoDRubro = 157) 
BEGIN
	INSERT INTO tCTLdominiosRubros(IdTipoDDominio, IdTipoDRubro, IdTipoDCuentaContable, Orden, IdEstatus, IdTipoDCuentaContablePadre, IdTipoDCuentaContableGrupo, IdAuxiliar, Grupo) 
	VALUES (2637, 157, 0, 11, 1, 0, 0, 0, '3. Compras') END
IF NOT EXISTS(SELECT IdDominioRubro FROM tCTLdominiosRubros WHERE IdTipoDDominio =  2637 AND IdTipoDRubro = 158) 
BEGIN
	INSERT INTO tCTLdominiosRubros(IdTipoDDominio, IdTipoDRubro, IdTipoDCuentaContable, Orden, IdEstatus, IdTipoDCuentaContablePadre, IdTipoDCuentaContableGrupo, IdAuxiliar, Grupo) 
	VALUES (2637, 158, 0, 12, 1, 0, 0, 0, '3. Compras') END
IF NOT EXISTS(SELECT IdDominioRubro FROM tCTLdominiosRubros WHERE IdTipoDDominio =  2637 AND IdTipoDRubro = 159) 
BEGIN
	INSERT INTO tCTLdominiosRubros(IdTipoDDominio, IdTipoDRubro, IdTipoDCuentaContable, Orden, IdEstatus, IdTipoDCuentaContablePadre, IdTipoDCuentaContableGrupo, IdAuxiliar, Grupo) 
	VALUES (2637, 159, 0, 13, 1, 0, 0, 0, '3. Compras') END
IF NOT EXISTS(SELECT IdDominioRubro FROM tCTLdominiosRubros WHERE IdTipoDDominio =  2637 AND IdTipoDRubro = 160) 
BEGIN
	INSERT INTO tCTLdominiosRubros(IdTipoDDominio, IdTipoDRubro, IdTipoDCuentaContable, Orden, IdEstatus, IdTipoDCuentaContablePadre, IdTipoDCuentaContableGrupo, IdAuxiliar, Grupo) 
	VALUES (2637, 160, 0, 1, 1, 0, 0, 0, '2. Ventas') END
IF NOT EXISTS(SELECT IdDominioRubro FROM tCTLdominiosRubros WHERE IdTipoDDominio =  2637 AND IdTipoDRubro = 161) 
BEGIN
	INSERT INTO tCTLdominiosRubros(IdTipoDDominio, IdTipoDRubro, IdTipoDCuentaContable, Orden, IdEstatus, IdTipoDCuentaContablePadre, IdTipoDCuentaContableGrupo, IdAuxiliar, Grupo) 
	VALUES (2637, 161, 0, 8, 1, 0, 0, 0, '2. Ventas') END
IF NOT EXISTS(SELECT IdDominioRubro FROM tCTLdominiosRubros WHERE IdTipoDDominio =  2637 AND IdTipoDRubro = 162) 
BEGIN
	INSERT INTO tCTLdominiosRubros(IdTipoDDominio, IdTipoDRubro, IdTipoDCuentaContable, Orden, IdEstatus, IdTipoDCuentaContablePadre, IdTipoDCuentaContableGrupo, IdAuxiliar, Grupo) 
	VALUES (2637, 162, 0, 9, 1, 0, 0, 0, '2. Ventas') END
IF NOT EXISTS(SELECT IdDominioRubro FROM tCTLdominiosRubros WHERE IdTipoDDominio =  2637 AND IdTipoDRubro = 163) 
BEGIN
	INSERT INTO tCTLdominiosRubros(IdTipoDDominio, IdTipoDRubro, IdTipoDCuentaContable, Orden, IdEstatus, IdTipoDCuentaContablePadre, IdTipoDCuentaContableGrupo, IdAuxiliar, Grupo) 
	VALUES (2637, 163, 0, 2, 1, 0, 0, 0, '2. Ventas') END
IF NOT EXISTS(SELECT IdDominioRubro FROM tCTLdominiosRubros WHERE IdTipoDDominio =  2637 AND IdTipoDRubro = 164) 
BEGIN
	INSERT INTO tCTLdominiosRubros(IdTipoDDominio, IdTipoDRubro, IdTipoDCuentaContable, Orden, IdEstatus, IdTipoDCuentaContablePadre, IdTipoDCuentaContableGrupo, IdAuxiliar, Grupo) 
	VALUES (2637, 164, 0, 3, 1, 0, 0, 0, '2. Ventas') END
IF NOT EXISTS(SELECT IdDominioRubro FROM tCTLdominiosRubros WHERE IdTipoDDominio =  2637 AND IdTipoDRubro = 165) 
BEGIN
	INSERT INTO tCTLdominiosRubros(IdTipoDDominio, IdTipoDRubro, IdTipoDCuentaContable, Orden, IdEstatus, IdTipoDCuentaContablePadre, IdTipoDCuentaContableGrupo, IdAuxiliar, Grupo) 
	VALUES (2637, 165, 0, 4, 1, 0, 0, 0, '2. Ventas') END
IF NOT EXISTS(SELECT IdDominioRubro FROM tCTLdominiosRubros WHERE IdTipoDDominio =  2637 AND IdTipoDRubro = 166) 
BEGIN
	INSERT INTO tCTLdominiosRubros(IdTipoDDominio, IdTipoDRubro, IdTipoDCuentaContable, Orden, IdEstatus, IdTipoDCuentaContablePadre, IdTipoDCuentaContableGrupo, IdAuxiliar, Grupo) 
	VALUES (2637, 166, 0, 5, 1, 0, 0, 0, '2. Ventas') ENDGO------------------------------------------------------------------------------------------------------
/* ==========================================
  Por:  David Vázquez Palestino
Fecha:  02/12/2019
=============================================*/
IF EXISTS (SELECT OBJECT_ID FROM SYS.PROCEDURES WHERE OBJECT_ID = OBJECT_ID('pCNTgenerarMovimientosInterSucursalPoliza'))
	DROP PROCEDURE pCNTgenerarMovimientosInterSucursalPoliza
GO

CREATE PROCEDURE dbo.pCNTgenerarMovimientosInterSucursalPoliza
@IdPolizaE INT = 0
AS

DECLARE @Partida INT = (SELECT MAX(Partida) FROM dbo.tCNTpolizasD WITH(NOLOCK) WHERE IdPolizaE = @IdPolizaE)

INSERT INTO dbo.tCNTpolizasD( IdPolizaE, Partida, IdCuentaContable, IdCentroCostos, Referencia, Concepto, Cargo, Abono,
                              IdDivisa, IdSucursal, IdAsientoD, EsCargo )
SELECT IdPolizaE=@IdPolizaE,
       Partida = @Partida + ROW_NUMBER()OVER (ORDER BY x.IdSucursal),
       IdCuentaContable,
       IdCentroCostos = -1,
       Referencia='',
       Concepto='',
       Cargo=IIF(x.CambioNeto<0, ABS(x.CambioNeto), 0),
       Abono=IIF(x.CambioNeto>0, ABS(x.CambioNeto), 0),
       IdDivisa,
       Sucursal.IdSucursal,
       IdAsientoD=0,
       EsCargo=IIF(x.CambioNeto<0, 1, 0)

FROM tCTLconfiguracion Configuracion
INNER JOIN dbo.tCNTcuentas Cuenta ON Configuracion.ValorCodigo=Cuenta.Codigo
INNER JOIN
    (   SELECT p.IdSucursal,
               CambioNeto =SUM(p.Cargo - p.Abono)			   
        FROM dbo.tCNTpolizasD p WITH(NOLOCK)
        INNER JOIN dbo.tCNTcuentas c WITH(NOLOCK) ON c.IdCuentaContable=p.IdCuentaContable
        WHERE IdPolizaE=@IdPolizaE
        GROUP BY p.IdSucursal ) AS x ON ABS(x.CambioNeto) >0
INNER JOIN dbo.tCTLsucursales Sucursal WITH(NOLOCK) ON Sucursal.IdSucursal=x.IdSucursal
WHERE Configuracion.IdConfiguracion = 18;	

GO


/* ==========================================
  Por:  David Vázquez Palestino
Fecha:  02/12/2019
=============================================*/
IF EXISTS (SELECT OBJECT_ID FROM SYS.PROCEDURES WHERE OBJECT_ID = OBJECT_ID('pCRUDoperacionesD'))
DROP PROCEDURE pCRUDoperacionesD
GO

CREATE PROCEDURE [dbo].[pCRUDoperacionesD]
    @TipoOperacion VARCHAR(5),
    @IdOperacionD AS INT = 0 OUTPUT,
    @RelOperacionD AS INT = 0,
    @IdRelValoresCampos AS INT = 0,
    @Partida AS INT = 0,
    @IdTipoDDominioDestino AS INT = 0,
    @IdBienServicio AS INT = 0,
    @DescripcionBienServicio AS VARCHAR(2048) = 0,
    @IdActivo AS INT = 0,
    @Concepto AS VARCHAR(80) = '',
    @Referencia AS VARCHAR(30) = '',
    @IdDivision AS INT = 0,
    @IdProyecto AS INT = 0,
    @IdAuxiliar AS INT = 0,
    @IdEntidad1 AS INT = 0,
    @IdEntidad2 AS INT = 0,
    @IdEntidad3 AS INT = 0,
    @IdAlmacen AS INT = 0,
    @IdListaDUDM AS INT = 0,
    @UDMdescripcion AS VARCHAR(MAX) = '',
    @FactorUDMalmacen AS NUMERIC(9, 6) = 0,
    @Cantidad AS NUMERIC(23, 6) = 0,
    @CantidadPendiente AS NUMERIC(23, 6) = 0,
    @CantidadEntregada AS NUMERIC(23, 6) = 0,
    @CantidadSolicitada AS NUMERIC(23, 6) = 0,
    @CantidadDevuelta AS NUMERIC(23, 6) = 0,
    @MontoPendiente AS NUMERIC(23, 6) = 0,
    @MontoPendienteLocal AS NUMERIC(23, 6) = 0,
    @PorcentajeRealizado AS NUMERIC(9, 6) = 0,
    @IdTipoDprecio AS INT = 0,
    @IdListaPrecios AS INT = 0,
    @PrecioLista AS NUMERIC(23, 6) = 0,
    @PrecioSinImpuestos AS NUMERIC(23, 6) = 0,
    @PrecioSinImpuestosLocal AS NUMERIC(23, 6) = 0,
    @PrecioConImpuestos AS NUMERIC(23, 6) = 0,
    @PrecioConImpuestosLocal AS NUMERIC(23, 6) = 0,
    @ImporteSinDescuento AS NUMERIC(23, 6) = 0,
    @ImporteSinDescuentoLocal AS NUMERIC(23, 6) = 0,
    @IdTipoDdescuento AS INT = 0,
    @DescuentoPorcentaje AS NUMERIC(9, 6) = 0,
    @Descuento AS NUMERIC(23, 6) = 0,
    @DescuentoLocal AS NUMERIC(23, 6) = 0,
    @Subtotal AS NUMERIC(23, 6) = 0,
    @SubtotalLocal AS NUMERIC(23, 6) = 0,
    @IdImpuesto AS INT = 0,
    @Impuestos AS NUMERIC(23, 6) = 0,
    @ImpuestosLocal AS NUMERIC(23, 6) = 0,
    @Total AS NUMERIC(23, 6) = 0,
    @TotalLocal AS NUMERIC(23, 6) = 0,
    @Costo AS NUMERIC(23, 6) = 0,
    @CostoLocal AS NUMERIC(23, 6) = 0,
    @CostoTotal AS NUMERIC(23, 6) = 0,
    @CostoTotalLocal AS NUMERIC(23, 6) = 0,
    @IdOperacionDOrigen AS INT = 0,
    @IdOperacionDPaquete AS INT = 0,
    @FechaRequerida AS DATE = '19000101',
    @FechaPrometida AS DATE = '19000101',
    @OrdenCompraCliente AS VARCHAR(30) = '',
    @FechaOrdenCompraCliente AS DATE = '19000101',
    @DiasEntrega AS INT = 0,
    @RequisicionCliente AS VARCHAR(30) = '',
    @IdRelImpuestos AS INT = 0,
    @PorcentajeDeducible AS NUMERIC(23, 6) = 0,
    @IdInformacionDepreciacion AS INT = 0,
    @IdInformacionComponente AS INT = 0,
    @IdSucursal AS INT = 0,
    @IdEstructuraContableE AS INT = 0,
    @IdCorte AS INT = 0,
    @IdMovimiento AS INT = 0,
    @IdEstatus AS INT = 0,
    @IdUsuarioAlta AS INT = 0,
    @IdUsuarioCambio AS INT = 0,
    @IdTipoDdominio AS INT = 0,
    @IdObservacionEEstatus AS INT = 0,
    @IdObservacionE AS INT = 0,
    @IdSesion AS INT = 0,
    @BaseExenta AS NUMERIC(23, 8) = 0,
    @BaseExentaLocal AS NUMERIC(23, 8) = 0,
    @BaseIVACero AS NUMERIC(23, 8) = 0,
    @BaseIVACeroLocal AS NUMERIC(23, 8) = 0,
    @BaseIVA AS NUMERIC(23, 8) = 0,
    @BaseIVALocal AS NUMERIC(23, 8) = 0,
    @IVA AS NUMERIC(23, 8) = 0,
    @IVALocal AS NUMERIC(23, 8) = 0,
    @RetencionIVA AS NUMERIC(23, 8) = 0,
    @RetencionIVALocal AS NUMERIC(23, 8) = 0,
    @ISR AS NUMERIC(23, 8) = 0,
    @ISRLocal AS NUMERIC(23, 8) = 0,
    @RetencionISR AS NUMERIC(23, 8) = 0,
    @RetencionISRLocal AS NUMERIC(23, 8) = 0,
    @IEPS AS NUMERIC(23, 8) = 0,
    @IEPSLocal AS NUMERIC(23, 8) = 0,
    @Impuesto1 AS NUMERIC(23, 8) = 0,
    @Impuesto1Local AS NUMERIC(23, 8) = 0,
    @RetencionImpuesto1 AS NUMERIC(23, 8) = 0,
    @RetencionImpuesto1Local AS NUMERIC(23, 8) = 0,
    @Impuesto2 AS NUMERIC(23, 8) = 0,
    @Impuesto2Local AS NUMERIC(23, 8) = 0,
    @RetencionImpuesto2 AS NUMERIC(23, 8) = 0,
    @RetencionImpuesto2Local AS NUMERIC(23, 8) = 0,
    @IdTipoDominioOrigen AS INT = 0,
    @IdTipoDominioDestino AS INT = 0,
    @IdCargoDescuento AS INT = 0,
    @Generado AS NUMERIC(23, 8) = 0,
    @Pagado AS NUMERIC(23, 8) = 0,
    @NumeroMovimiento AS INT = 0,
    @IdCentroCostos AS INT = 0,
    @ImporteGravado AS NUMERIC(23, 8) = 0,
    @ImporteExento AS NUMERIC(23, 8) = 0,
    @ImporteDeduccionGravado AS NUMERIC(23, 8) = 0,
    @ImporteDeduccionExento AS NUMERIC(23, 8) = 0,
    @IdAuxiliarRetencionIVA AS INT = 0,
    @IdAuxiliarRetencionISR AS INT = 0,
    @IdTipoSubOperacion AS INT = 0,
    --
    @IdEstatusDominio AS INT = 1,
    @PendienteClasificar AS BIT = 0,
    @AfectaInventario AS BIT = 0,
    @IdProductoServicio INT = 0,
    @IdUnidadMedida INT = 0
AS
--VERSION 2.1.3
BEGIN

    SET NOCOUNT ON;
    SET XACT_ABORT ON;

    DECLARE @Alta DATETIME = CURRENT_TIMESTAMP;
    DECLARE @UltimoCambio DATETIME = CURRENT_TIMESTAMP;

    IF (@TipoOperacion = 'C')
    BEGIN

        DECLARE @ControlExistencia AS BIT = 0;

       IF( @IdBienServicio != 0 )
		BEGIN

			SELECT  @IdEstructuraContableE = IIF(@IdEstructuraContableE = 0, IdEstructuraContableE, @IdEstructuraContableE),
					-- Sí es Artículo / Activo fijo y el tipo de aplicación es "Afecta al gasto" entonces vamos afectar el almacén mediante la operaciónD
					@AfectaInventario = CASE WHEN IdTipoDDominio IN ( 139, 142 )  THEN 1
											 ELSE 0
										END,
					@IdTipoDDominioDestino = IdTipoDDominio,
					@PendienteClasificar = CASE WHEN IdTipoDDominio IN (142, 2248, 2587) THEN 1 ELSE 0 END

			FROM dbo.vGRLbienesServiciosEstructuras
			WHERE IdBienServicio = @IdBienServicio;

			SET @FactorUDMalmacen = IIF(@FactorUDMalmacen = 0, 1, @FactorUDMalmacen);

			
			SELECT @IdAlmacen = IIF(@IdAlmacen = 0 AND bServicio.ControlExistencias = 1, almacen.IdAlmacen, @IdAlmacen)
			FROM dbo.tGRLbienesServicios bServicio
			INNER JOIN dbo.tCTLsucursales sucursal ON sucursal.IdSucursal = @IdSucursal
			INNER JOIN dbo.tALMalmacenes almacen ON almacen.IdSucursal    = sucursal.IdSucursal
			WHERE bServicio.IdBienServicio = @IdBienServicio;
		END;

        INSERT INTO [dbo].[tGRLoperacionesD]
        (
            RelOperacionD,
            IdRelValoresCampos,
            Partida,
            IdTipoDDominioDestino,
            IdBienServicio,
            DescripcionBienServicio,
            IdActivo,
            Concepto,
            [Referencia],
            IdDivision,
            IdProyecto,
            IdAuxiliar,
            IdEntidad1,
            IdEntidad2,
            IdEntidad3,
            IdAlmacen,
            IdListaDUDM,
            UDMdescripcion,
            FactorUDMalmacen,
            Cantidad,
            CantidadPendiente,
            CantidadEntregada,
            CantidadSolicitada,
            CantidadDevuelta,
            MontoPendiente,
            PorcentajeRealizado,
            IdTipoDprecio,
            IdListaPrecios,
            PrecioLista,
            PrecioSinImpuestos,
            PrecioConImpuestos,
            ImporteSinDescuento,
            ImporteSinDescuentoLocal,
            IdTipoDdescuento,
            DescuentoPorcentaje,
            Descuento,
            DescuentoLocal,
            Subtotal,
            IdImpuesto,
            Impuestos,
            Total,
            TotalLocal,
            Costo,
            CostoLocal,
            CostoTotal,
            CostoTotalLocal,
            IdOperacionDOrigen,
            IdOperacionDPaquete,
            FechaRequerida,
            FechaPrometida,
            OrdenCompraCliente,
            FechaOrdenCompraCliente,
            DiasEntrega,
            RequisicionCliente,
            IdRelImpuestos,
            PorcentajeDeducible,
            IdInformacionDepreciacion,
            IdInformacionComponente,
            IdSucursal,
            IdEstructuraContableE,
            IdCorte,
            [IdMovimiento],
            IdEstatus,
            IdUsuarioAlta,
            Alta,
            IdUsuarioCambio,
            UltimoCambio,
            IdTipoDdominio,
            IdObservacionEEstatus,
            IdObservacionE,
            IdSesion,
            BaseExenta,
            BaseExentaLocal,
            BaseIVACero,
            BaseIVACeroLocal,
            BaseIVA,
            BaseIVALocal,
            IVA,
            IVALocal,
            RetencionIVA,
            RetencionIVALocal,
            ISR,
            ISRLocal,
            RetencionISR,
            RetencionISRLocal,
            IEPS,
            IEPSLocal,
            Impuesto1,
            Impuesto1Local,
            RetencionImpuesto1,
            RetencionImpuesto1Local,
            Impuesto2,
            Impuesto2Local,
            RetencionImpuesto2,
            RetencionImpuesto2Local,
            IdTipoDominioOrigen,
            IdTipoDominioDestino,
            IdCargoDescuento,
            Generado,
            Pagado,
            NumeroMovimiento,
            IdCentroCostos,
            ImporteGravado,
            ImporteExento,
            ImporteDeduccionGravado,
            ImporteDeduccionExento,
            IdAuxiliarRetencionIVA,
            IdAuxiliarRetencionISR,
            IdTipoSubOperacion,
            IdEstatusDominio,
            PendienteClasificar,
            IdProductoServicio,
            IdUnidadMedida
        )
        VALUES
        (@RelOperacionD, @IdRelValoresCampos, @Partida, @IdTipoDDominioDestino, @IdBienServicio,
         @DescripcionBienServicio, @IdActivo, @Concepto, @Referencia, @IdDivision, @IdProyecto, @IdAuxiliar,
         @IdEntidad1, @IdEntidad2, @IdEntidad3, @IdAlmacen, @IdListaDUDM, @UDMdescripcion, @FactorUDMalmacen,
         @Cantidad, @CantidadPendiente, @CantidadEntregada, @CantidadSolicitada, @CantidadDevuelta, @MontoPendiente,
         @PorcentajeRealizado, @IdTipoDprecio, @IdListaPrecios, @PrecioLista, @PrecioSinImpuestos, @PrecioConImpuestos,
         @ImporteSinDescuento, @ImporteSinDescuentoLocal, @IdTipoDdescuento, @DescuentoPorcentaje, @Descuento,
         @DescuentoLocal, @Subtotal, @IdImpuesto, @Impuestos, @Total, @TotalLocal, @Costo, @CostoLocal, @CostoTotal,
         @CostoTotalLocal, @IdOperacionDOrigen, @IdOperacionDPaquete, @FechaRequerida, @FechaPrometida,
         @OrdenCompraCliente, @FechaOrdenCompraCliente, @DiasEntrega, @RequisicionCliente, @IdRelImpuestos,
         @PorcentajeDeducible, @IdInformacionDepreciacion, @IdInformacionComponente, @IdSucursal,
         @IdEstructuraContableE, @IdCorte, @IdMovimiento, @IdEstatus, @IdUsuarioAlta, @Alta, @IdUsuarioCambio,
         @UltimoCambio, @IdTipoDdominio, @IdObservacionEEstatus, @IdObservacionE, @IdSesion, @BaseExenta,
         @BaseExentaLocal, @BaseIVACero, @BaseIVACeroLocal, @BaseIVA, @BaseIVALocal, @IVA, @IVALocal, @RetencionIVA,
         @RetencionIVALocal, @ISR, @ISRLocal, @RetencionISR, @RetencionISRLocal, @IEPS, @IEPSLocal, @Impuesto1,
         @Impuesto1Local, @RetencionImpuesto1, @RetencionImpuesto1Local, @Impuesto2, @Impuesto2Local,
         @RetencionImpuesto2, @RetencionImpuesto2Local, @IdTipoDominioOrigen, @IdTipoDominioDestino, @IdCargoDescuento,
         @Generado, @Pagado, @NumeroMovimiento, @IdCentroCostos, @ImporteGravado, @ImporteExento,
         @ImporteDeduccionGravado, @ImporteDeduccionExento, @IdAuxiliarRetencionIVA, @IdAuxiliarRetencionISR,
         @IdTipoSubOperacion, @IdEstatusDominio, @PendienteClasificar, @IdProductoServicio, @IdUnidadMedida);

        SET @IdOperacionD = SCOPE_IDENTITY();



        --Actualizar Cargos descuentos
        IF @IdCargoDescuento != 0
        BEGIN
            IF EXISTS
            (
                SELECT tg.IdTipoOperacion
                FROM tGRLoperaciones tg
                WHERE tg.IdTipoOperacion = 6
                      AND tg.IdOperacion = @RelOperacionD
            )
            BEGIN
                UPDATE c
                SET c.Condonado += @Subtotal
                FROM tSDOcargosDescuentos c
                WHERE c.IdCargoDescuento = @IdCargoDescuento;
            END;
            ELSE
            BEGIN
                UPDATE c
                SET Generado += @Generado,
                    Pagado += @Pagado
                FROM tSDOcargosDescuentos c
                WHERE c.IdCargoDescuento = @IdCargoDescuento;
            END;
            EXEC dbo.pCTLactualizarAplicacionCargoDescuento @TipoOperacion = 'ACTDOPD',            -- varchar(20)
                                                            @IdCargoDescuento = @IdCargoDescuento, -- int
                                                            @IdTransaccion = 0,                    -- int
                                                            @IdOperacionD = @IdOperacionD;         -- int			          	
        END;

    END;

    IF (@TipoOperacion = 'R')
    BEGIN
        EXEC pCRUDoperacionesDR @IdOperacionD = @IdOperacionD;
    END;

    IF (@TipoOperacion = 'U')
    BEGIN
        UPDATE [dbo].[tGRLoperacionesD]
        SET RelOperacionD = @RelOperacionD,
            IdRelValoresCampos = @IdRelValoresCampos,
            Partida = @Partida,
            IdTipoDDominioDestino = @IdTipoDDominioDestino,
            IdBienServicio = @IdBienServicio,
            DescripcionBienServicio = @DescripcionBienServicio,
            IdActivo = @IdActivo,
            Concepto = @Concepto,
            Referencia = @Referencia,
            IdDivision = @IdDivision,
            IdProyecto = @IdProyecto,
            IdAuxiliar = @IdAuxiliar,
            IdEntidad1 = @IdEntidad1,
            IdEntidad2 = @IdEntidad2,
            IdEntidad3 = @IdEntidad3,
            IdAlmacen = @IdAlmacen,
            IdListaDUDM = @IdListaDUDM,
            FactorUDMalmacen = @FactorUDMalmacen,
            Cantidad = @Cantidad,
            CantidadPendiente = @CantidadPendiente,
            CantidadEntregada = @CantidadEntregada,
            CantidadSolicitada = @CantidadSolicitada,
            CantidadDevuelta = @CantidadDevuelta,
            MontoPendiente = @MontoPendiente,
            PorcentajeRealizado = @PorcentajeRealizado,
            IdTipoDprecio = @IdTipoDprecio,
            IdListaPrecios = @IdListaPrecios,
            PrecioLista = @PrecioLista,
            PrecioSinImpuestos = @PrecioSinImpuestos,
            PrecioConImpuestos = @PrecioConImpuestos,
            ImporteSinDescuento = @ImporteSinDescuento,
            ImporteSinDescuentoLocal = @ImporteSinDescuentoLocal,
            IdTipoDdescuento = @IdTipoDdescuento,
            DescuentoPorcentaje = @DescuentoPorcentaje,
            Descuento = @Descuento,
            DescuentoLocal = @DescuentoLocal,
            Subtotal = @Subtotal,
            IdImpuesto = @IdImpuesto,
            Impuestos = @Impuestos,
            Total = @Total,
            TotalLocal = @TotalLocal,
            Costo = @Costo,
            CostoLocal = @CostoLocal,
            CostoTotal = @CostoTotal,
            CostoTotalLocal = @CostoTotalLocal,
            IdOperacionDOrigen = @IdOperacionDOrigen,
            IdOperacionDPaquete = @IdOperacionDPaquete,
            FechaRequerida = @FechaRequerida,
            FechaPrometida = @FechaPrometida,
            OrdenCompraCliente = @OrdenCompraCliente,
            FechaOrdenCompraCliente = @FechaOrdenCompraCliente,
            DiasEntrega = @DiasEntrega,
            RequisicionCliente = @RequisicionCliente,
            IdRelImpuestos = @IdRelImpuestos,
            PorcentajeDeducible = @PorcentajeDeducible,
            IdInformacionDepreciacion = @IdInformacionDepreciacion,
            IdInformacionComponente = @IdInformacionComponente,
            IdSucursal = @IdSucursal,
            IdEstructuraContableE = @IdEstructuraContableE,
            IdCorte = @IdCorte,
            [IdMovimiento] = @IdMovimiento,
            IdEstatus = @IdEstatus,
            IdUsuarioCambio = @IdUsuarioCambio,
            UltimoCambio = @UltimoCambio,
            IdTipoDdominio = @IdTipoDdominio,
            IdObservacionEEstatus = @IdObservacionEEstatus,
            IdObservacionE = @IdObservacionE,
            IdSesion = @IdSesion,
            BaseExenta = @BaseExenta,
            BaseExentaLocal = @BaseExentaLocal,
            BaseIVACero = @BaseIVACeroLocal,
            BaseIVACeroLocal = @BaseIVACeroLocal,
            BaseIVA = @BaseIVA,
            BaseIVALocal = @BaseIVALocal,
            IVA = @IVA,
            IVALocal = @IVALocal,
            RetencionIVA = @RetencionIVA,
            RetencionIVALocal = @RetencionIVALocal,
            ISR = @ISR,
            ISRLocal = @ISRLocal,
            RetencionISR = @RetencionISR,
            RetencionISRLocal = @RetencionISRLocal,
            IEPS = @IEPS,
            IEPSLocal = @IEPSLocal,
            Impuesto1 = @Impuesto1,
            Impuesto1Local = @Impuesto1Local,
            RetencionImpuesto1 = @RetencionImpuesto1,
            RetencionImpuesto1Local = @RetencionImpuesto1Local,
            Impuesto2 = @Impuesto2,
            Impuesto2Local = @Impuesto2Local,
            RetencionImpuesto2 = @RetencionImpuesto2,
            RetencionImpuesto2Local = @RetencionImpuesto2Local,
            ImporteGravado = @ImporteGravado,
            ImporteExento = @ImporteExento,
            ImporteDeduccionGravado = @ImporteDeduccionGravado,
            ImporteDeduccionExento = @ImporteDeduccionExento,
            IdProductoServicio = @IdProductoServicio,
            IdUnidadMedida = @IdUnidadMedida
        WHERE (IdOperacionD = @IdOperacionD);
    END;

    IF (@TipoOperacion = 'D')
    BEGIN
        DELETE FROM [dbo].[tGRLoperacionesD]
        WHERE (IdOperacionD = @IdOperacionD);
    END;

    IF (@TipoOperacion = 'CNL') --Cancelación
    BEGIN
        UPDATE tGRLoperacionesD
        SET IdEstatus = 18
        WHERE IdOperacionD = @IdOperacionD;
    END;

END;

GO


/* ==========================================
  Por:  David Vázquez Palestino
Fecha:  02/12/2019
=============================================*/
IF EXISTS(SELECT OBJECT_ID FROM SYS.VIEWS WHERE OBJECT_ID = OBJECT_ID('vCONproveedor'))
	DROP VIEW dbo.vCONproveedor
GO

CREATE VIEW [dbo].[vCONproveedor]
AS
SELECT  tSCSemisoresProveedores.IdEmisorProveedor,
		tSCSemisoresProveedores.Codigo,	
		RFC,
		NombreComercial,
		Nombre,
		Domicilio,
		tSCSemisoresProveedores.EsProveedor,
		tCTLestatus.IdEstatus,
		EstatusCodigo = tCTLestatus.Codigo,
		EstatusDescripcion = Descripcion

FROM tSCSemisoresProveedores WITH(NOLOCK)
JOIN tSCSsociosComerciales	 WITH(NOLOCK) ON tSCSemisoresProveedores.IdEmisorProveedor = tSCSsociosComerciales.IdEmisorProveedor
JOIN tGRLpersonas			 WITH(NOLOCK) ON tGRLpersonas.IdPersona = tSCSemisoresProveedores.IdPersona
JOIN tCTLestatusActual		 WITH(NOLOCK) ON tCTLestatusActual.IdEstatusActual = tSCSemisoresProveedores.IdEstatusActual
JOIN tCTLestatus			 WITH(NOLOCK) ON tCTLestatusActual.IdEstatus = tCTLestatus.IdEstatus
WHERE tSCSemisoresProveedores.IdEmisorProveedor != 0 

GO
-------------------------------------------

UPDATE tCTLconsultas SET  Filtro = 'IdTipoDDominio IN (1575, 139, 141, 2248)' WHERE IdConsulta = 415 